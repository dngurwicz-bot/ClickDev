# נעילת רשומות ושחרורן

## הבעיה
מצב שבו שני מדווחים מעדכנים באותו זמן את נתוניו של אותו עובד הוא מצב לא תקין: עדכון של אחד המדווחים עלול לדרוס את העדכון של המדווח האחר.

## הפתרון: נעילת רשומות
- רשומת העובד או רשומת המפעל ננעלות בנסיבות מסוימות
- **נעילה** = רק המשתמש שנעל רשאי לעדכן
- משתמשים אחרים רשאים **לעיין** ברשומה אך לא לעדכנה
- רשומה נעולה נשארת נעולה עד לשחרורה

---

## שירות 2 - עדכון מאגר הנתונים

### נעילת רשומות

| סוג רשומה | מתי ננעלת | היקף הנעילה |
|-----------|----------|-------------|
| **רשומת עובד** | הגעה לשירות 2 עם עובד מסוים או החלפת מספר עובד | בשלמותה, ללא תלות באירוע |
| **רשומת מפעל** | ברמת אירוע | רק האירוע הספציפי (כגון 106) |

> **הערה**: רק עובד אחד נעול על-ידי משתמש אחד

### שחרור רשומות

שחרור רשומה מתבצע במצבים הבאים:

1. **יציאה מוחלטת משירות 2** - חזרה לתפריט הראשי
   - מעבר בניתוב ישיר לשירות אחר או יציאה למסך תפריט **אינו משחרר**
   
2. **מעבר לרשומה אחרת** - שינוי מספר העובד וביצוע פעולה
   - משחרר את הרשומה הקודמת
   - נועל את הרשומה הנוכחית

3. **שחרור אוטומטי** - לאחר זמן נעילה ממושך

---

## שירות 4 - חישוב מדגמי

### נעילת רשומות

| סוג פעולה | מה ננעל |
|-----------|---------|
| חישוב אמת בקובץ מדגמי | רשומת מפעל + רשומת עובד בקובץ הפלט |
| חישוב MAV למדגמי | רשומת מפעל + רשומת עובד בקובץ הפלט |
| רשומת עובד בקובץ ביניים | ננעלת עם התחלת החישוב (כולל חישוב מוסבר) |

**מתי מתבצעת הנעילה?**
- אחרי הודעה: "העתקת עובד לקובץ ביניים מתבצעת, המתן ..."
- **משמעות**: לא ייתכן ששני משתמשים יבצעו חישוב מדגמי לאותו עובד בו-זמנית
- הנעילה היא רק בקובץ הביניים - אפשר לעדכן את רשומת העובד בזמן חישוב מדגמי

### שחרור רשומות
- כל הרשומות משתחררות **בסוף החישוב**
- ברגע שמקבלים מסך של תוצאות החישוב
- שחרור אוטומטי לאחר זמן נעילה ממושך

---

## קביעת זמן מקסימלי לנעילת רשומה

### הבעיה
לפעמים משתמש נועל רשומה לזמן רב (למשל יציאה להפסקת צהריים בזמן שנמצא בשירות 2)

### הפתרון
הגדרת זמן מקסימלי לנעילת רשומה:
- **הגדרה**: אירוע 105, שגרה 70007, סמל-1 (בדקות)
- **סמל-1 = 0**: זמן הנעילה אינו מוגבל
- **ללא שגרה 70007**: ברירת מחדל = 60 דקות

### מה קורה אחרי שחרור אוטומטי?
- הרשומה נחשבת כמשוחררת
- משתמש אחר יכול לעבוד איתה
- כשהמשתמש המקורי חוזר - מקבל הודעה שעליו להפעיל את התהליך מתחילתו
- זאת כדי לנעול את הרשומה מחדש
